# The Script:
## Description :
the bash script that perform uni/bi CommsMatrix tests and rely on the conf file as an input to determine its behavior
## Logic :
![Alt Flow](./TestCommsMatrix.png?raw=true "Logic")
### Localhost execution :
1. basic validation:
    - is configuration file passed to the script as an argument
    - is the script running in compatible environment
    - is the configuration file has any duplicates blocks/attributes
2. install local dependencies 
    - install any required dependencies on localhost mainly "at" package 
3. write a script friendly configuration file
    - write another configuration file and fill any missing attributes with defaults if exist
4. start advanced validation 
    - check if any block missing an attribute or has incompatible 
    - check attributes values if its valid 
    - check the accessibility and privileges on remote ips 
5. install dependencies on remote machines
    - install any required software on remote machines at/netstat/[nc/socat] depend on TCPPackage attribute
6. start generate tester/listeners scripts
    - read the conf file block by block and generate the required listeners/testers scripts , if TestOnlyTcp: true then testers only will be generated
    - execute listeners scripts if TestOnlyTcp: false
    - once listener finished execution the testers start testing, if TestOnlyTcp: true then testers will be executed directly
7. create local task for report/log gathering
    - once tester finish all testing  vs all listeners the reports gathered to the localhost or if TestOnlyTcp: true
    - once all testers in specific block finished testing the log gathering start
    - the csv updated 
### listerners execution: [TestOnlyTcp:false]
    - if firewalld running will be stopped during ListenDuration
    - if target ports already open will not be touched
    - if targeted ports closed will be listening during the ListenDuration
    - logs Saved to will be saved ~[user]/CommsMatrix/[ConfFileName]-[Date]/Logs/Listening/
### Testers execution:
    - will not start scan a port range before making sure the range endport is listening
    - reports will be saved on ~[user]/CommsMatrix/[ConfFileName]-[Date]/Reports
    - logs will be saved ~[user]/CommsMatrix/[ConfFileName]-[Date]/Logs/Listening/
    - after the tester script finished execution will create the flag file at ~[user]/CommsMatrix/[ConfFileName]-[Date]/[BlockName]/Reports/[TesterIP]
## Prequiste :
    - remote-user    : have to be sudo with no passwd and authenticate with the public key
## Files Generated:
### description :
    - files get generated by the script for Scripts/troubleshooting/reporting/logging path:   [HOME]/CommsMatrixData/[ConfFileName]-[Date]/
### location:
    - localhost:
        configuration-file:
            description: the conf file used when the script executed
            path: [ConfFileName].conf
        Logging-file:
            description: the localhost execution logs
            path: [ConfFileName].log
        stats-file:
            description: once the tests finished stats will be saved in that csv file 
            path: [ConfFileName].csv
        scripts:
            description: the scripts generated by the CommsMatrix Script to be executed on remote listeners and testers and localtasks for reports and logs gathering
            path:
                ListenerScripts:	"[BlockName]-Scripts/Listeners/[ListenerIP]-udp.sh"
                TesterScripts:  	"[BlockName]-Scripts/Testers/[TesterIP]-[ListenerIP]-tcp.sh"
                ReportsGathering:   "[BlockName]-Scripts/ReportsGathering/pTesterIP].sh"
                logs_gathering.sh:  "[BlockName]-Scripts/logs_gathering.sh"
        reports:
            description:  the reports gathered from remote testers
            path:	"[BlockName]-Reports/[TesterIP]"
        logs:
            description:  the logs gathered from remote machines describe the execution progess
            path: "[BlockName]-Logs/[TesterIP&ListenerIP]"
    - TesterIP:
        reports:
            description:  the reports on testers
            path: "Reports/[tcp/udp]/[TesterIP]-[ListenerIP].txt"
        logs:
            description:  the logs on TesterIP describe the execution progress
            path:"[BlockName]-LocalLogs/[TesterIP]-[ListenerIP]-[tcp/udp].log"
        flags:
            description:   flag files used as an indication for the completion of all scan on specific block listeners ips
            path       :     "FLAGS/[flag]"
    - ListenerIP:
        logs:
            description:  the logs on Listener describe the execution progess
            path: "[BlockName]-LocalLogs/[ListenerIP]-[tcp/udp].log"
        flags:
            description:   flag files used as an indication for the completion of all ports in listen state
            path       :     "FLAGS/[flag]"
# The Configuration File:
## description:
- hold multiple [block] to determine the script behavior
## blocks:
        - types:
           Default:   hold default attributes "Mode,User/s,ListenDuration" other attributes are now allowed
           [Others]:   hold specific attributes for the block including "Mode,User/s,ListenDuration,IPs,Ports," , block name is one string [a-zA-Z]
        - attributes:
                Mode: specify the testing mode tester->listeners [uni] tester<->listener [bi]
                    available values:
                        - uni :   one  way communication matrix test
                        - bi  :   two way communication matrix test
                User:          the remote user
                ListenDurationInMinutes: port listen duration applied on tcp and udp ports on listeners
                UDPPorts:      mixed ranges/individual ports comma separated
                TCPPorts:      mixed ranges/individual ports comma separated
                TCPTestPackage: specify the package that will be user for listen/test port
                    available values:
                        - nc  : can be used if Mode:uni and no udp ports provided.
                        - socat: can be used in both uni/bi mode for tcp/udp test/listen
                TCPTestOnly: value that determine if we have access to listener ips to the ports or we will just test the connectivity to already existing ones.
                    available values:
                        - true:  script will not generate/execute listener scripts or test ssh/privilege on the listeners ips .
                        - false: script will test ssh/previlege on listener ips and listener scripts will be generate/executed on listeners .
                IPs: the remote ips                                      [ bi mode only ]
                TestersIPs:      the remote testerip, uni mode only      [ uni mode only ]
                ListenersIPs:    the remote listenerip , uni mode only   [ uni mode only ]
## Notes:
        - hashed and empty lines in Configuration File ignored
        - any attribute does not match documented one ignored
        - configuration are validated for consistency and script will exit if it is not consistent
        - IPs/TesterIPs/ListenerIPs:
                - the targeted ips can be mixed ranges/individual ips space or newline separated
                - the ip values are validated
                - range can be x.x.x.0-x.x.x.255 (right most)
                - IPS attribute is not allows in uni mode
                - TesterIPs/ListenersIPS attribute are not allowed in bi mode
        - listenDuration used in :
            - basically for how long  tcp/udp kept open ports will
            - for how long firewall will be stopped
        - following attributes can be set in default block 
            - User
            - ListenDurationInMinutes
            - Mode
            - TCPPackage
            - TCPTestOnly
# To be Improved:
    - Remove the ListenDuration so firewall will keep open/ports will keep listening as long testing not finished
    - Run Commands when load average is not high
# example:
        [Default]
        Mode: uni
        User: ansible
        ListenDurationInMinutes: 100
        [Block1]
        ListenDurationInMinutes: 10
        User: root
        TCPPorts:1001-1010,2000,3031-3040
        UDPPorts:4001-4010,5000,6011-6020
        TestersIPs:
        192.168.56.101
        192.168.56.102
        ListenersIPs:
        192.168.56.101
        192.168.56.102
        192.168.56.103
        192.168.56.104
        [Block2]
        Mode:bi
        TCPPorts:7001-7010,8000,9031-9040
        UDPPorts:10001-10010,11000,12011-12020
        IPs:
        192.168.56.101
        192.168.56.102
        192.168.56.103
        192.168.56.104